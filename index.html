<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×œ×•×— ××©×™××•×ª ×©×‘×•×¢×™</title>
<link rel="manifest" href="manifest.json">

<!-- OneSignal -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
body{font-family:system-ui;direction:rtl;background:#eef2ff;margin:0;padding:10px;}
h1{text-align:center;}
.nav{display:flex;justify-content:center;margin:10px;}
.nav button{margin:0 5px;padding:5px 10px;}
.week{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;}
.day{background:white;border-radius:12px;padding:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);}
.day-title{font-weight:bold;}
.day-date{font-size:13px;color:#555;margin-bottom:6px;}
.day.today{background:#fff9b1;}
.task{background:#e5e7eb;border-radius:8px;padding:6px;margin-bottom:6px;}
.task.past{background:#c7d2fe;}
.task.done{background:#bbf7d0;}
button{font-size:12px;margin:2px;}
.add{width:100%;}
.notify-btn{margin:10px;padding:8px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>

<h1>ğŸ“… ×œ×•×— ××©×™××•×ª</h1>

<div class="nav">
  <button onclick="prevWeek()">â¬… ×©×‘×•×¢ ×§×•×“×</button>
  <button onclick="nextWeek()">×©×‘×•×¢ ×”×‘× â¡</button>
</div>

<div id="notifyDiv">
  <button class="notify-btn" onclick="enableNotifications()">×”×¤×¢×œ ×”×ª×¨××•×ª</button>
</div>

<div class="week" id="week"></div>

<script>
/* ---- ×”×’×“×¨×ª PWA ---- */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if(confirm("×œ×”×ª×§×™×Ÿ ××ª ×”××¤×œ×™×§×¦×™×” ×œ××¡×š ×”×‘×™×ª?")) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(()=>{deferredPrompt=null;});
  }
});

if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}

/* ---- ××©×ª× ×™× ---- */
const daysNames=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
let tasks = JSON.parse(localStorage.getItem("tasks")||"[]");
let currentWeekOffset = 0;

/* ---- ×©××™×¨×ª ××©×™××•×ª ---- */
function saveTasks(){localStorage.setItem("tasks",JSON.stringify(tasks)); render(); scheduleAllNotifications();}

/* ---- ×™×¦×™×¨×ª ×©×‘×•×¢ ---- */
function getWeek(offset=0){
  const arr=[]; 
  const d=new Date(); 
  d.setDate(d.getDate()-d.getDay() + offset*7);
  for(let i=0;i<7;i++){const x=new Date(d); x.setDate(d.getDate()+i); arr.push(x);}
  return arr;
}

/* ---- ×”×¦×’×ª ×œ×•×— ---- */
function render(){
  const week=document.getElementById("week"); week.innerHTML="";
  const now=new Date();
  const todayStr=now.toISOString().split("T")[0];
  getWeek(currentWeekOffset).forEach(date=>{
    const key=date.toISOString().split("T")[0];
    const box=document.createElement("div"); box.className="day";
    if(key===todayStr && currentWeekOffset===0) box.classList.add("today");
    box.innerHTML=`<div class="day-title">${daysNames[date.getDay()]}</div><div class="day-date">${date.toLocaleDateString("he-IL")}</div>`;
    
    tasks.filter(t=>t.date===key).forEach(t=>{
      const taskTime=new Date(`${t.date}T${t.time}`);
      const div=document.createElement("div"); div.className="task";
      if(t.done) div.classList.add("done"); 
      else if(taskTime<now) div.classList.add("past");
      div.innerHTML=`
        â° ${t.time}<br>${t.text}<br>
        <button onclick="editTask('${t.id}')">âœï¸</button>
        <button onclick="deleteTask('${t.id}')">ğŸ—‘ï¸</button>
        <button onclick="doneTask('${t.id}')">âœ”</button>
      `;
      box.appendChild(div);
    });

    const btn=document.createElement("button"); btn.className="add"; btn.textContent="â• ×”×•×¡×£ ××©×™××”";
    btn.onclick=()=>addTask(key);
    box.appendChild(btn);
    week.appendChild(box);
  });
}

/* ---- ×”×•×¡×¤×” ---- */
function addTask(date){
  const text=prompt("×”×§×œ×“ ××ª ×”××©×™××”:"); if(!text) return;
  let time=""; while(!/^\d{2}:\d{2}$/.test(time)){time=prompt("×©×¢×” (HH:MM) - ×¨×§ ××¡×¤×¨×™×, ×œ×“×•×’××” 14:30):"); if(time===null) return;}
  
  const task={id:crypto.randomUUID(),date,time,text,done:false,notify:false};
  tasks.push(task);
  saveTasks();
  
  if(window.OneSignal) {
    OneSignal.push(function() {
      OneSignal.isPushNotificationsEnabled(function(isEnabled) {
        if(!isEnabled) {
          OneSignal.showNativePrompt();
        } else {
          if(confirm("×œ×”×¤×¢×™×œ ×”×ª×¨××” ×œ××©×™××” ×–×•?")) { task.notify=true; saveTasks(); }
        }
      });
    });
  }
}

/* ---- ×”×¤×¢×œ×ª ×”×ª×¨××•×ª ---- */
function enableNotifications(){
  if(window.OneSignal) {
    OneSignal.push(function() {
      OneSignal.showNativePrompt();
      alert("×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª! ×›×œ ××©×™××” ×¢× ×”×ª×¨××” ×ª×§×‘×œ Push ×’× ×›×©×”-PWA ×¡×’×•×¨.");
      document.getElementById("notifyDiv").style.display="none";
    });
  }
}

/* ---- ×¢×¨×™×›×” ---- */
function editTask(id){
  const t=tasks.find(x=>x.id===id);
  const text=prompt("×¢×¨×™×›×ª ××©×™××”:",t.text); if(text!==null) t.text=text;
  let time=t.time; while(!/^\d{2}:\d{2}$/.test(time)){time=prompt("×©×¢×” (HH:MM) - ×¨×§ ××¡×¤×¨×™×:",t.time); if(time===null) break;} if(time!==null) t.time=time;
  if(t.notify) { t.notify=confirm("×œ×”×¤×¢×™×œ ×”×ª×¨××” ×œ××©×™××” ×–×•?"); }
  saveTasks();
}

/* ---- ××—×™×§×” ×•×¡×™××•×Ÿ ---- */
function deleteTask(id){if(confirm("×œ××—×•×§ ××©×™××”?")){tasks=tasks.filter(t=>t.id!==id); saveTasks();}}
function doneTask(id){tasks.find(x=>x.id===id).done=true; saveTasks();}

/* ---- × ×™×•×•×˜ ×©×‘×•×¢×•×ª ---- */
function prevWeek(){currentWeekOffset--; render();}
function nextWeek(){currentWeekOffset++; render();}

/* ---- ×ª×–××•×Ÿ ×”×ª×¨××•×ª ---- */
function scheduleAllNotifications(){
  navigator.serviceWorker.ready.then(reg=>{
    const now=Date.now();
    tasks.forEach(t=>{
      if(!t.notify || t.done) return;
      const taskTime=new Date(`${t.date}T${t.time}`).getTime();
      if(taskTime>now){
        reg.active.postMessage({type:"schedule",task:t});
      }
    });
  });
}

/* ---- ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×›×œ ×©× ×™×™×” ---- */
setInterval(render,1000);

/* ---- ×”×ª×—×œ×” ---- */
render();
scheduleAllNotifications();
</script>
</body>
</html>
